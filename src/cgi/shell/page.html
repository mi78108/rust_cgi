<!DOCTYPE html>
<html style="width: 100%; height: 100%;">

  <head>
    <link rel="stylesheet" href="shell/shell/node_modules/xterm/css/xterm.css">
    <script src="shell/shell/node_modules/xterm/lib/xterm.js"></script>
    <script src="shell/shell/node_modules/xterm-addon-attach/lib/xterm-addon-attach.js"></script>
    <script src="shell/shell/node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="shell/shell/node_modules/xterm-addon-web-links/lib/xterm-addon-web-links.js"></script>
    <script src="shell/shell/node_modules/xterm-addon-serialize/lib/xterm-addon-serialize.js"></script>
    <script src="shell/shell/node_modules/xterm-addon-image/lib/xterm-addon-image.js"></script>
    <script src="shell/shell/node_modules/xterm-addon-webgl/lib/xterm-addon-webgl.js"></script>
    <script src="shell/shell/node_modules/xterm-addon-search/lib/xterm-addon-search.js"></script>
    <script src="shell/proc/auth_uid.js"></script>
    <script src="static/common.js"></script>

  </head>

  <body style="width: calc(100% -10px);height: calc(100% - 10px);">
    <div id="terminal" style="width: 100%; height: 80%; box-shadow: 0px -5px 5px 5px red;"></div>
    <div style="width: 100%; height: 20%; display: flex;">
      <div style="width: 50%; height: 100%; display: flex; border: 2px dashed black; box-sizing: border-box;">
        <div id="fileUpload" style="width: 100%;height: 100%; cursor: pointer;"
          onclick="document.getElementById('file').click()">
          <img src="shell/shell/icons/cloud-upload.svg" style="height: 60%; margin: auto; display: block;">
          <i id="file_i" style="margin: auto; text-align: center;display: block;">选择文件</i>
          <input id="file" type="file" style="display: none;">
        </div>
      </div>
      <div style="width: 50%; height: 100%; display: flex; border: 2px dashed black; box-sizing: border-box;">
        <div ondblclick="download_list()" id="fileDownload"
          style="width: 100%;height: 100%; font-size: small;overflow-y: auto; background-image: url('shell/shell/icons/cloud-download.svg');background-repeat: no-repeat;background-size: auto 60%;background-position: center;">
        </div>
      </div>
    </div>
    <script>
      const xterm = new Terminal({
        fontFamily: "'Symbols Nerd Font', 'monospace'", // 字体类型
        fontSize: 16,            // 字体大小
        fontWeight: 'normal',    // 字体粗细
        fontWeightBold: 'bold'   // 粗体字体的粗细
      });
      const addonFit = new FitAddon.FitAddon();
      const addonSerialize = new SerializeAddon.SerializeAddon();
      const addonSearch = new SearchAddon.SearchAddon(); //searchAddon.findNext('foo');
      const addonImage = new ImageAddon.ImageAddon({
        enableSizeReports: true,    // whether to enable CSI t reports (see below)
        pixelLimit: 16777216,       // max. pixel size of a single image
        sixelSupport: true,         // enable sixel support
        sixelScrolling: true,       // whether to scroll on image output
        sixelPaletteLimit: 256,     // initial sixel palette size
        sixelSizeLimit: 25000000,   // size limit of a single sixel sequence
        storageLimit: 128,          // FIFO storage limit in MB
        showPlaceholder: true,      // whether to show a placeholder for evicted images
        iipSupport: true,           // enable iTerm IIP support
        iipSizeLimit: 20000000      // size limit of a single IIP sequence
      })
      xterm.open(document.getElementById('terminal'));
      xterm.loadAddon(addonFit);
      xterm.loadAddon(addonImage);
      xterm.loadAddon(addonSearch);
      xterm.loadAddon(addonSerialize);
      xterm.loadAddon(new WebglAddon.WebglAddon());
      xterm.loadAddon(new WebLinksAddon.WebLinksAddon());
      addonFit.fit();

      xterm.write("Ready To Auth By Email? [Enter] ...");
      let ev_data_xterm = xterm.onData((char) => {
        if (char === '\x0d') {
          xterm.reset()
          ev_data_xterm.dispose();
          fetch(`shell/proc/auth_uid.js?uid=${window.uid}`).then(resp => resp.json()).then(resp => {
            window.authcode = "";
            window.offline = true;
            xterm.write("Input AuthCode:");
            ev_data_xterm = xterm.onData((char) => {
              console.log('key input', char)
              if (window.offline) {
                if (char === '\x0d') {
                  ev_data_xterm.dispose();
                  xterm.writeln("\r\nAuthing ...");
                  window.attachAddon = new AttachAddon.AttachAddon(new WebSocket(`shell/index?uid=${window.uid}&code=${window.authcode}&rows=${xterm.rows}&cols=${xterm.cols}`), { bidirectional: true });
                  window.attachAddon._socket.onopen = () => {
                    window.offline = false
                    document.getElementById('terminal').style.boxShadow = '0px -5px 5px 5px green'
                  }
                  window.attachAddon._socket.onclose = () => {
                    window.offline = true
                    document.getElementById('terminal').style.boxShadow = '0px -5px 5px 5px red'
                  }
                  window.attachAddon._socket.onerror = () => {
                    window.offline = true
                    document.getElementById('terminal').style.boxShadow = '0px -5px 5px 5px orange'
                  }
                  xterm.loadAddon(window.attachAddon)
                } else {
                  xterm.write('*');
                  window.authcode += char;
                }
              }
            })
          }).catch(e => {
            console.error(e)
            xterm.writeln("\r\nAuth erro")
          })
        }
      })

      window.addEventListener('resize', () => {
        clearTimeout(window.timer)
        window.timer = setTimeout(() => {
          addonFit.fit();
          if(window.attachAddon){
            window.attachAddon._sendData(`\x0d\x07\x0d${JSON.stringify({
              o: 'xterm_resize',
              cols: xterm.cols,
              rows: xterm.rows
            })}`);
          }
        }, 500)
      })

      document.getElementById('file').onchange = (ev) => {
        let file = ev.target.files[0];
        document.getElementById('file_i').innerHTML = `${file.name}<br>${file.size / 1024 / 1024} mb`
        let uploader = new tools.file_uploader(`shell/upload`, file, window.uploadWorkerSize, window.uploadChunkSize);
        uploader.upload_init().then(resp => {
          uploader.start_jobs()
        })
        uploader.triggerd = (ev, info)=>{
          xterm.writeln(`${new Date().format("yyyy-MM-dd hh:mm:ss")} ${ev} ${JSON.stringify(info.log)}`)
        }
        uploader.on('progress', (info) => {
          console.log(`>>>> process event ,<${info}>`)
          if (info.opt == 'finished') {
            download_list()
          }
        })
        window.uploader = uploader;
      }

      tools.target_drag_event(document.getElementById('fileUpload'),(files)=>{
        tools.dialog_file_uploader.open('shell/upload', files[0], ()=>{
          download_list()
        })
      })
      //window.timer_download_list = setInterval(() => download_list(), 1000 * 60)
    </script>
    <script>
      let download_list = () => {
        fetch("shell/download/list").then(resp => resp.json()).then(resp => {
          document.getElementById('fileDownload').innerHTML = resp.map(f => {
            return `<div style="white-space: nowrap;;cursor: pointer; " title='${JSON.stringify(f)}'><img src="shell/shell/icons/${f.type === 'dir' ? 'gtk-directory.svg' : 'gtk-file.svg'}"><a href="shell/download/${f.name}" download>${f.name}</a></div>`
          }).join("")
        })
      }

      Date.prototype.format = function (fmt) {
        var o = {
          "M+": this.getMonth() + 1, //月份需+1
          "d+": this.getDate(),
          "h+": this.getHours(),
          "m+": this.getMinutes(),
          "s+": this.getSeconds(),
          "q+": Math.floor((this.getMonth() + 3) / 3), //季度
          "S": this.getMilliseconds()
        };
        if (/(y+)/.test(fmt))
          fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
          if (new RegExp("(" + k + ")").test(fmt))
            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
      }
    </script>
  </body>

</html>

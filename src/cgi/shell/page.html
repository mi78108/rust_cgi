<!DOCTYPE html>
<html style="width: 100%; height: 100%;">
  <head>
    <link rel="stylesheet" href="/shell/shell/node_modules/xterm/css/xterm.css">
    <script src="/shell/shell/node_modules/xterm/lib/xterm.js"></script>
    <script src="/shell/shell/node_modules/xterm-addon-attach/lib/xterm-addon-attach.js"></script>
    <script src="/shell/shell/node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="/shell/shell/node_modules/xterm-addon-web-links/lib/xterm-addon-web-links.js"></script>
    <script src="/shell/shell/node_modules/xterm-addon-serialize/lib/xterm-addon-serialize.js"></script>
    <script src="/shell/shell/node_modules/xterm-addon-image/lib/xterm-addon-image.js"></script>
    <script src="/shell/shell/node_modules/xterm-addon-webgl/lib/xterm-addon-webgl.js"></script>
    <script src="/shell/proc/auth_uid.js"></script>

  </head>
  <body style="width: calc(100% -10px);height: calc(100% - 10px);">
    <div id="terminal" style="width: 100%; height: 80%;"></div>
    <div style="width: 100%; height: 20%; display: flex;">
      <div style="width: 50%; height: 100%; display: flex; border: 2px dashed black; box-sizing: border-box;">
        <div id="fileUpload" style="width: 100%;height: 100%; cursor: pointer;">
          <img src="/shell/shell/icons/cloud-upload.svg" style="height: 60%; margin: auto; display: block;">
          <i id="file_i" style="margin: auto; text-align: center;display: block;">选择文件</i>
          <input id="file" type="file" style="display: none;">
        </div>
      </div>
      <div style="width: 50%; height: 100%; display: flex; border: 2px dashed black; box-sizing: border-box;">
        <div id="fileDownload" style="width: 100%;height: 100%; font-size: small;overflow-y: auto;">
        </div>
      </div>
    </div>
    <script>
      window.onload = function() {
        console.log("page load done")
        const xterm = new Terminal({
          fontFamily: "'Symbols Nerd Font', 'monospace'", // 字体类型
          fontSize: 16,            // 字体大小
          fontWeight: 'normal',    // 字体粗细
          fontWeightBold: 'bold'   // 粗体字体的粗细
        });
        window.xterm = xterm;
        const addonFit = new FitAddon.FitAddon();
        const addonSerialize = new SerializeAddon.SerializeAddon();
        const addonImage = new ImageAddon.ImageAddon({
          enableSizeReports: true,    // whether to enable CSI t reports (see below)
          pixelLimit: 16777216,       // max. pixel size of a single image
          sixelSupport: true,         // enable sixel support
          sixelScrolling: true,       // whether to scroll on image output
          sixelPaletteLimit: 256,     // initial sixel palette size
          sixelSizeLimit: 25000000,   // size limit of a single sixel sequence
          storageLimit: 128,          // FIFO storage limit in MB
          showPlaceholder: true,      // whether to show a placeholder for evicted images
          iipSupport: true,           // enable iTerm IIP support
          iipSizeLimit: 20000000      // size limit of a single IIP sequence
        })
        xterm.open(document.getElementById('terminal'));
        xterm.loadAddon(addonFit);
        xterm.loadAddon(addonImage);
        xterm.loadAddon(addonSerialize);
        xterm.loadAddon(new WebglAddon.WebglAddon());
        xterm.loadAddon(new WebLinksAddon.WebLinksAddon());
        addonFit.fit();

        if(window.document){
          window.unauthed = true;
          window.authcode = "";
          xterm.write("Input AuthCode:")
          xterm.onData(char=>{
            if(window.unauthed ===  true){
              if(char === '\x0d'){
                const attachAddon = new AttachAddon.AttachAddon(new WebSocket(`/shell/index?uid=${window.uid}&code=${window.authcode}&rows=${xterm.rows}&cols=${xterm.cols}`));
                xterm.loadAddon(attachAddon);
                window.unauthed = false;
                xterm.writeln("Authing ...");
              }else{
                xterm.write('*');
                window.authcode += char;
              }
            }
          })
        };

        window.addEventListener('resize', ()=>{
          clearTimeout(window.timer)
          window.timer = setTimeout(()=>{
            addonFit.fit();
            fetch(`/shell/config`,{
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },body: JSON.stringify({
                cols:xterm.cols,
                rows:xterm.rows
              })
            }).then(resp => resp.json()).then(resp=> console.log(resp)).finally(()=>{
              addonFit.fit()
            })
          },200)
        })

        document.getElementById('fileUpload').onclick = (ev) => {
          document.getElementById('file').click()
        }
        let info = document.getElementById('info')
        let upload_file_process_pre = (file) => {
          return fetch(`/shell/upload/pre?fn=${file.name}&fs=${file.size}`,{
            method: 'POST'
          }).then(resp=>resp.json())
        }

        let upload_file_process = (file, index, chunkSize, count)=>{  
          file.uploadWorkingSize += 1;
          let chunk = file.slice(index * chunkSize, (index + 1) * chunkSize);
          let reader = new FileReader();
          reader.readAsArrayBuffer(chunk);
          reader.onload = (data) => {
            fetch(`/shell/upload?fn=${file.name}&id=${index}&ct=${count}&cs=${chunkSize}`,{
              method: 'POST', body: data.target.result
            }).then(resp => resp.json()).then(resp=> {
              file.uploadedIndexs.push(index)
              console.log(resp,`${index} 上传成功; 下一片`)
              info.innerHTML = `${new Date()}>${file.name} ${file.uploadedIndexs.length}/${file.uploadCount} 完成<br>`
              if(file.uploadedIndexs.length === file.uploadCount){
                console.log(resp,`${index} 上传完成`)
                info.innerHTML = `${new Date()}>${file.name} ${count} 上传完成<br>`
              }else{
                file.start_jobs()
              }
            }).catch((resp)=>{
              console.log(resp,`${index} 上传失败; 重新传`)
              info.innerHTML = `${new Date()}>${file.name} [${index}] 上传失败 尝试重传<br>`
              setTimeout(()=>{
                upload_file_process(file, index, chunkSize)
              },2000)
            }).finally(()=>{
              file.uploadWorkingSize -= 1;
              chunk = null;
              data = null;
              reader = null;
              if(file.uploadedIndexs.length === file.uploadCount){
                file = null;
              }
            })
          }
        }
        document.getElementById('file').onchange = (ev) => {
          let file = ev.target.files[0];
          info.innerHTML = `${new Date()}>${file.name} 正在查询相关信息 ...`
          document.getElementById('file_i').innerHTML = `${file.name}<br>${file.size / 1024 / 1024} mb`
          upload_file_process_pre(file).then(resp=>{
            console.log(resp)
            info.innerHTML = `${new Date()}>${file.name} ${resp.info}`
            if(resp.code === 0){
              file.uploadedIndexs = [];
              file.uploadingIndexs = [];
              file.uploadWorkingSize = 0;
              file.uploadCount = Math.ceil(file.size / window.uploadChunkSize)

              file.start_jobs = ()=>{
                if(file.uploadingIndexs.length === file.uploadCount){
                  console.log("worker 工作分派完成")
                  return
                }
                for(let i = 0; i < file.uploadCount; i++){
                  if(file.uploadingIndexs.indexOf(i) === -1){
                    if(file.uploadWorkingSize <= window.uploadWorkerSize){
                      file.uploadingIndexs.push(i);
                      upload_file_process(file, i, window.uploadChunkSize, file.uploadCount)
                    }else{
                      break
                    }
                  }
                }
                console.info(`${new Date()} worker info ${file.uploadWorkingSize} : ${file.uploadingIndexs.length} / ${file.uploadCount} = ${file.uploadedIndexs.length}`)
              }
              file.start_jobs()
            }
          })
        }

        document.getElementById('fileDownload').ondblclick = (ev) => {
          fetch("/shell/download/list").then(resp=>resp.json()).then(resp=>{
            document.getElementById('fileDownload').innerHTML = resp.map(f=>{
              return `<div style="white-space: nowrap;;cursor: pointer; " title='${JSON.stringify(f)}'><img src="/shell/shell/icons/${f.type === 'dir'?'gtk-directory.svg':'gtk-file.svg'}"><a href="/shell/download/${f.name}" download>${f.name}</a></div>`
            }).join("")
          })
        };
        document.getElementById('fileDownload').dispatchEvent(new MouseEvent('dblclick'))
      };
    </script>
  </body>
</html>
